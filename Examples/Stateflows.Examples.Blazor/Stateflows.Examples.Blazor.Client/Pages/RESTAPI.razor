@page "/rest-api"
@inject IJSRuntime jsRuntime

@* Replaced server-side IBehavior usage with vanilla JS calling autogenerated REST endpoints.
   Machine id used here: "Doc" — adjust if your runtime uses different id. *@

<PageTitle>Blazor Server (JS-driven)</PageTitle>

<script>
    const machineName = "Doc";
    let currentInstance = "";
    let notificationsSource = null;

    function baseUrl(instance) {
        return `/stateflows/stateMachines/${encodeURIComponent(machineName)}/${encodeURIComponent(instance)}`;
    }

    function setElementText(id, text) {
        const el = document.getElementById(id);
        if (el) el.textContent = JSON.stringify(text, null, 2);
    }

    async function fetchJson(url, options) {
        const r = await fetch(url, options);
        const txt = await r.text();
        return txt
            ? JSON.parse(txt)
            : txt;
    }

    function setButtons(expectedEvents) {
        const has = (name) => expectedEvents && expectedEvents.indexOf(name) !== -1;

        document.getElementById("btn-review").classList.toggle("hide", !has("Stateflows.Examples.Common.Events.Review"));
        document.getElementById("btn-approve-manager").classList.toggle("hide", !has("Stateflows.Examples.Common.Events.Approve"));
        document.getElementById("btn-approve-finance").classList.toggle("hide", !has("Stateflows.Examples.Common.Events.Approve"));
        document.getElementById("btn-pay").classList.toggle("hide", !has("Stateflows.Examples.Common.Events.PaymentBooked"));
        document.getElementById("btn-reject").classList.toggle("hide", !has("Stateflows.Examples.Common.Events.Reject"));
    }

    function generateGUID() {
        const array = new Uint32Array(8);
        window.crypto.getRandomValues(array);
        let str = '';
        for (let i = 0; i < array.length; i++) {
            str += array[i].toString(16).padStart(8, '0');
        }
        return str;
    }

    async function create() {
        currentInstance = generateGUID();

        startNotificationsListener();

        await fetch(`${baseUrl(currentInstance)}/initialize`, {
            headers: {
                'Accept': 'application/json',
                'Content-Type': 'application/json'
            },
            method: "POST",
            body: JSON.stringify({ payload: {} }),
        });
    }

    async function review() {
        const content = prompt("Provide a review (minimum 8 characters):");
        if (content === null) return; // cancelled

        const result = await fetchJson(`${baseUrl(currentInstance)}/review`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ Event: { Content : content, Rating: 42 }})
        });

        console.log(result);
        if (result && result.status && result.statusText === "Invalid" && !result.eventValidation.isValid) {
            // adapt to your API's validation result shape
            alert("Validation error: " + result.eventValidation.validationResults[0].errorMessage);
        }
    }

    async function approve(role) {
        // role -> header X-Role: Manager | Finance (adjust header name if different)
        await fetchJson(`${baseUrl(currentInstance)}/approve`, {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-Role": role
            },
            body: JSON.stringify({ }),
        });
    }

    async function pay() {
        await fetchJson(`${baseUrl(currentInstance)}/paymentBooked`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ Event: { Amount: 500 }})
        });
    }

    async function rejectDoc() {
        await fetchJson(`${baseUrl(currentInstance)}/reject`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({})
        });
    }

    function startNotificationsListener() {
        stopNotificationsListener();

        notificationsSource = new EventSource(`${baseUrl(currentInstance)}/notifications?stream=true&names=Stateflows.StateMachines.StateMachineInfo&names=PlantUmlInfo&names=Stateflows.Examples.Common.Events.RejectionNotification&names=Stateflows.Examples.Common.Events.InvoiceNotification`);

        notificationsSource.addEventListener("PlantUmlInfo", (e) => {
            let data = JSON.parse(e.data);
            const p = document.getElementById("plantUml");
            p.src = data.Payload.PNGUrl;
        });

        notificationsSource.addEventListener("Stateflows.StateMachines.StateMachineInfo", (e) => {
            let data = JSON.parse(e.data);
            setButtons(data.Payload.ExpectedEvents);
        });

        notificationsSource.addEventListener("Stateflows.Examples.Common.Events.RejectionNotification", (e) => {
            let data = JSON.parse(e.data);
            alert(data.Payload.Reason);
        });

        notificationsSource.addEventListener("Stateflows.Examples.Common.Events.InvoiceNotification", (e) => {
            alert("Invoice is created, payment time!");
        });
    }

    function stopNotificationsListener() {
        if (notificationsSource != null) {
            notificationsSource.close();
        }
    }

    // expose simple cleanup when navigating away

    window.addEventListener("beforeunload", () => stopNotificationsListener());
</script>

<h3>Hello, Adventurer!</h3>
<h5>Here you can manage document's state.</h5>

<blockquote>
    <p>This page is running on Blazor Server but the UI actions are implemented in vanilla JS.</p>
    <p>Interaction with <a href="https://github.com/Stateflows/framework/wiki/behaviors" target="_blank">Stateflows behaviors</a> is available via autogenerated <strong>REST endpoints</strong> - read about <a href="https://github.com/Stateflows/framework/wiki/Extensions#Stateflows-Extensions-MinimalAPIs">Stateflows.Extensions.MinimalAPIs</a> to learn more.</p>
</blockquote>

<div class="site">
    <button id="btn-create" class="btn btn-success" onclick="create()">Create new</button>
    <button id="btn-review" class="btn btn-primary hide" onclick="review()">Review</button>
    <button id="btn-approve-manager" class="btn btn-primary hide" onclick="approve('Manager')">Approve as manager</button>
    <button id="btn-approve-finance" class="btn btn-primary hide" onclick="approve('Finance')">Approve as finance</button>
    <button id="btn-pay" class="btn btn-primary hide" onclick="pay()">Pay</button>
    <button id="btn-reject" class="btn btn-primary hide" onclick="rejectDoc()">Reject</button>

    <br/>
    <img id="plantUml" src="" style="margin-top:1rem; max-width:100%" />
</div>
