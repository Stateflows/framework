var I=Object.defineProperty;var $=Object.getOwnPropertyDescriptor;var R=Object.getOwnPropertyNames;var E=Object.prototype.hasOwnProperty;var T=a=>{throw TypeError(a)};var W=(a,t)=>{for(var e in t)I(a,e,{get:t[e],enumerable:!0})},P=(a,t,e,i)=>{if(t&&typeof t=="object"||typeof t=="function")for(let s of R(t))!E.call(a,s)&&s!==e&&I(a,s,{get:()=>t[s],enumerable:!(i=$(t,s))||i.enumerable});return a};var A=a=>P(I({},"__esModule",{value:!0}),a);var b=(a,t,e)=>t.has(a)||T("Cannot "+e);var n=(a,t,e)=>(b(a,t,"read from private field"),e?e.call(a):t.get(a)),d=(a,t,e)=>t.has(a)?T("Cannot add the same private member more than once"):t instanceof WeakSet?t.add(a):t.set(a,e),m=(a,t,e,i)=>(b(a,t,"write to private field"),i?i.call(a,e):t.set(a,e),e);var B={};W(B,{UseHttp:()=>k});module.exports=A(B);var l=require("@stateflows/common");var f,g=class{constructor(t){d(this,f);this.watches=[];m(this,f,t)}get behaviorId(){return n(this,f).id}handleNotifications(t){let e=this.watches.map(i=>i.notificationName);t.forEach(i=>{e.indexOf(i.name)!==-1&&n(this,f).notify(i)})}};f=new WeakMap;var v=class{constructor(t,e){this.notificationName=t;this.milisecondsSinceLastNotificationCheck=e;this.handlers=[];this.notifications=[]}};var C=require("@stateflows/common");var o,y,u,w=class{constructor(t){this.url=t;d(this,o,new Map);d(this,y,[]);d(this,u);t.slice(-1)!="/"&&(t=t+"/")}updateTimestamp(t){n(this,o).forEach(e=>{e.watches.forEach(i=>{i.lastNotificationCheck=t,delete i.milisecondsSinceLastNotificationCheck})})}handleNotifications(t,e=null){for(let s of n(this,o).values())s.watches.forEach(r=>{r.lastNotificationCheck=e,delete r.milisecondsSinceLastNotificationCheck});let i=new Map;t.forEach(s=>{if(n(this,y).includes(s.id))return;delete s.senderId.$type,delete s.senderId.behaviorClass.$type,delete s.senderId.behaviorClass.environment;let r=l.JsonUtils.stringify(s.senderId);i.set(r,i.has(r)?[...i.get(r),s]:[s])});for(let s of i.keys()){let r=i.get(s),c=n(this,o).get(s);if(typeof c!="undefined"){let h=c.watches.map(p=>p.notificationName);c.handleNotifications(r.filter(p=>h.indexOf(p.name)!==-1))}}m(this,y,t.map(s=>s.id))}getWatches(t){t=l.JsonUtils.deepClone(t),delete t.$type,delete t.behaviorClass.$type;let e=l.JsonUtils.stringify(t);return n(this,o).has(e)?n(this,o).get(e).watches.map(s=>({notificationName:s.notificationName,lastNotificationCheck:s.lastNotificationCheck,milisecondsSinceLastNotificationCheck:s.milisecondsSinceLastNotificationCheck!==null?Date.now()-s.milisecondsSinceLastNotificationCheck:null})):[]}async getAvailableClasses(){return await(await fetch(`${this.url}stateflows/availableClasses`)).json()}async send(t,e){let i=e.payload.$type.split(",")[0].split("."),s=i[i.length-1];s==="CompoundRequest"&&(s=e.payload.events.map(x=>{let S=x.$type.split(",")[0].split(".");return S[S.length-1]}).join(","));let c=await(await fetch(`${this.url}stateflows/send?${s}`,{method:"POST",headers:{Accept:"application/json","Content-Type":"application/json"},body:l.JsonUtils.stringify({$type:"Stateflows.Common.Transport.Classes.StateflowsRequest, Stateflows.Common.Transport",behaviorId:t,event:e,watches:this.getWatches(t)})})).json(),h=c.response,p=c.validation;return h&&(e.payload.response=h.payload),this.handleNotifications(c.notifications,c.responseTime),new l.SendResult(e,c.eventStatus,p)}async watch(t,e){n(this,u)==null&&m(this,u,setInterval(this.watchIntervalCallback.bind(this),10*1e3));let i=l.JsonUtils.deepClone(t.id);delete i.$type,delete i.behaviorClass.$type;let s=l.JsonUtils.stringify(i),r=n(this,o).has(s)?n(this,o).get(s):new g(t);n(this,o).set(s,r),r.watches.findIndex(h=>h.notificationName===e)===-1&&r.watches.push(new v(e,Date.now()))}async unwatch(t,e){if(n(this,o).has(l.JsonUtils.stringify(t.id))){let i=n(this,o).get(l.JsonUtils.stringify(t.id)),s=i.watches.findIndex(r=>r.notificationName===e);s!==-1&&delete i.watches[s],n(this,o).delete(l.JsonUtils.stringify(t.id))}}async watchIntervalCallback(){n(this,o).size!==0&&n(this,o).forEach(async t=>{await this.send(t.behaviorId,new C.EventHolder(new C.NotificationsRequest))})}};o=new WeakMap,y=new WeakMap,u=new WeakMap;var N=class{constructor(t){this.url=t}getTransport(){return Promise.resolve(new w(this.url))}};function k(a){return new N(a)}0&&(module.exports={UseHttp});
//# sourceMappingURL=index.js.map